<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>流星雨音乐播放</title>
    <style>
        body {
            margin: 0;
            overflow: hidden;
            background-color: #000;
            touch-action: manipulation;
            font-family: Arial, sans-serif;
        }

        canvas {
            display: block;
        }

        #info {
            position: fixed;
            bottom: 20px;
            left: 20px;
            color: white;
            background-color: rgba(0, 0, 0, 0.5);
            padding: 10px;
            border-radius: 5px;
            font-size: 14px;
            pointer-events: none;
            z-index: 100;
        }

        #score {
            position: fixed;
            top: 20px;
            right: 20px;
            color: white;
            font-size: 24px;
            background-color: rgba(0, 0, 0, 0.5);
            padding: 10px;
            border-radius: 5px;
            z-index: 100;
        }

        #music-control {
            position: fixed;
            bottom: 20px;
            right: 20px;
            color: white;
            background-color: rgba(0, 0, 0, 0.7);
            padding: 10px;
            border-radius: 50%;
            width: 40px;
            height: 40px;
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            z-index: 100;
            border: 1px solid rgba(255, 255, 255, 0.3);
        }

        #music-control i {
            font-size: 20px;
        }

        #music-info {
            position: fixed;
            bottom: 70px;
            right: 20px;
            color: white;
            background-color: rgba(0, 0, 0, 0.5);
            padding: 10px;
            border-radius: 5px;
            font-size: 12px;
            max-width: 200px;
            display: none;
        }

        #lyrics-container {
            position: fixed;
            bottom: 120px;
            left: 0;
            right: 0;
            color: white;
            text-align: center;
            z-index: 100;
            pointer-events: auto;
            /* 允许用户交互 */
            max-height: 40vh;
            overflow-y: auto;

            /* 允许垂直滚动 */
            /* 隐藏滚动条 */
            &::-webkit-scrollbar {
                display: none;
            }

            -ms-overflow-style: none;
            /* IE和Edge */
            scrollbar-width: none;
            /* Firefox */
        }

        .lyrics-line {
            font-size: 18px;
            margin: 10px 0;
            opacity: 0.6;
            transition: all 0.3s ease;
            text-shadow: 0 0 5px rgba(0, 0, 0, 0.8);
        }

        .lyrics-line.active {
            opacity: 1;
            font-size: 22px;
            font-weight: bold;
            text-shadow: 0 0 10px rgba(255, 255, 255, 0.8);
        }

        @media (max-width: 768px) {
            #info {
                font-size: 12px;
                bottom: 10px;
                left: 10px;
            }

            #score {
                font-size: 18px;
                top: 10px;
                right: 10px;
            }

            #music-control {
                bottom: 10px;
                right: 10px;
                width: 35px;
                height: 35px;
            }

            #music-control i {
                font-size: 18px;
            }

            #music-info {
                bottom: 55px;
                right: 10px;
            }

            #lyrics-container {
                bottom: 100px;
            }

            .lyrics-line {
                font-size: 16px;
            }

            .lyrics-line.active {
                font-size: 18px;
            }
        }
    </style>
    <!-- 引入Font Awesome图标 -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0-beta3/css/all.min.css">
</head>

<body>
    <canvas id="starCanvas"></canvas>
    <div id="info">点击或触摸屏幕创建流星<br>长按创建流星风暴</div>
    <div id="score">流星: 0</div>
    <div id="music-control" title="播放/暂停音乐">
        <i class="fas fa-music"></i>
    </div>
    <div id="music-info">音乐加载中...</div>
    <div id="lyrics-container"></div>

    <!-- 音频元素 -->
    <audio id="bgMusic" loop>
        <source src="http://101.200.33.160/music/%E5%94%AF%E4%B8%80-G.E.M.%E9%82%93%E7%B4%AB%E6%A3%8B.mp3"
            type="audio/mpeg">
        您的浏览器不支持音频元素。
    </audio>

    <script>
        const canvas = document.getElementById('starCanvas');
        const ctx = canvas.getContext('2d');
        const infoDiv = document.getElementById('info');
        const scoreDiv = document.getElementById('score');
        const musicControl = document.getElementById('music-control');
        const musicInfo = document.getElementById('music-info');
        const lyricsContainer = document.getElementById('lyrics-container');
        const bgMusic = document.getElementById('bgMusic');

        // 音乐相关变量
        let musicPlaying = false;
        let musicInitialized = false;

        let filteredLyrics; // 全局声明
        const currentTrack = {
            name: "唯一 - G.E.M.邓紫棋",
            url: "http://101.200.33.160/music/%E5%94%AF%E4%B8%80-G.E.M.%E9%82%93%E7%B4%AB%E6%A3%8B.mp3"
        };

        // 您的LRC歌词数据
        const lrcText = `[ar:G.E.M. 邓紫棋]
[ti:唯一]
[by:]
[al:T.I.M.E.]
[offset:0]
[00:00.000]G.E.M. 邓紫棋 - 唯一
[00:02.173]作词：告五人、云安
[00:02.892]作曲：告五人、云安
[00:03.224]改编词曲：G.E.M. 邓紫棋
[00:03.633]制作人：G.E.M. 邓紫棋、T-Ma
[00:09.940]编曲：G.E.M. 邓紫棋、T-Ma
[00:15.272]你真的懂唯一的定义
[00:21.136]并不简单如呼吸
[00:28.448]你真的希望你能厘清
[00:34.440]若没交心怎么说明
[00:40.243]我真的爱你 句句不轻易
[00:53.820]眼神中飘移
[00:59.564]总是在关键时刻清楚洞悉
[01:07.372]你的不坚定 配合我颠沛流离
[01:20.258]死去中清醒 明白你背着我聪明
[01:48.205]那些我 想说的 没说的 话
[01:54.709]有时我 怀疑呢 只是我 傻瓜
[02:01.453]但如果真的爱 不会算计
[02:04.869]爱是不嫉妒 不张狂 不求自己
[02:08.141]无关你的回应 永不止息
[02:12.849]你知道
[02:13.609]我真的爱你 没人能比拟
[02:26.897]眼神没肯定
[02:32.754]总是在关键时刻清楚洞悉
[02:40.273]你的不坚定 配合我颠沛流离
[02:53.523]死去中清醒 明白你背着我聪明
[03:06.123]我知道
[03:06.987]爱本质无异 是因为人多得拥挤
[03:20.307]你不想证明 证明我是你唯一
[03:32.851]证明我是你唯一
[03:38.192]混音：Claudia Koh
[03:39.144]母带：T-Ma马敬恒
[03:40.653]OP：更漂亮音乐工作室
[03:42.705]SP：相信音乐国际股份有限公司`;

        // 修复后的LRC解析器
        function parseLRC(lrcText) {
            const lines = lrcText.split('\n');
            const result = [];
            let offset = 0;

            // 提取offset值（使用正确的方括号）
            const offsetMatch = lrcText.match(/\[offset:([+-]?\d+)\]/i);
            if (offsetMatch) {
                offset = parseInt(offsetMatch[1]) / 1000; // 转换为秒
            }

            // 使用正确的方括号匹配时间标签 [mm:ss.xx]
            const timeRegex = /\[(\d{2}):(\d{2})\.(\d{2,3})\]/g;

            for (const line of lines) {
                // 跳过空行和元数据行
                if (!line.trim() || line.startsWith('[ar:') || line.startsWith('[ti:') ||
                    line.startsWith('[al:') || line.startsWith('[by:') ||
                    line.startsWith('[offset:') || line.startsWith('[ve:')) {
                    continue;
                }

                // 提取所有时间标签和歌词文本
                const matches = [...line.matchAll(timeRegex)];
                const text = line.replace(timeRegex, '').trim();

                if (matches.length > 0 && text) {
                    for (const match of matches) {
                        const minutes = parseInt(match[1]);
                        const seconds = parseInt(match[2]);
                        const milliseconds = parseInt(match[3].length === 2 ? match[3] + '0' : match[3]);

                        let time = minutes * 60 + seconds + milliseconds / 1000;
                        time += offset;
                        time = Math.max(0, time);

                        result.push({ time, text });
                    }
                }
            }

            result.sort((a, b) => a.time - b.time);
            return result;
        }

        // 解析LRC歌词
        const lyrics = parseLRC(lrcText);

        // 初始化歌词显示 - 过滤掉非歌词内容
        function initLyrics() {
            lyricsContainer.innerHTML = '';
            // 过滤歌词
            filteredLyrics = lyrics.filter(line =>
                !line.text.includes("作词：") &&
                !line.text.includes("作曲：") &&
                !line.text.includes("编曲：") &&
                !line.text.includes("制作人：") &&
                !line.text.includes("混音：") &&
                !line.text.includes("母带：") &&
                !line.text.includes("OP：") &&
                !line.text.includes("SP：") &&
                !line.text.match(/G\.E\.M\. 邓紫棋 - 唯一/)
            );
            // 创建歌词 DOM 元素
            filteredLyrics.forEach((line, index) => {
                const div = document.createElement('div');
                div.className = 'lyrics-line';
                div.textContent = line.text;
                div.dataset.time = line.time;
                lyricsContainer.appendChild(div);
            });
        }

        // 更新当前播放的歌词 - 增强版
        function updateLyrics(currentTime) {
            const lines = document.querySelectorAll('.lyrics-line');
            let activeLineIndex = -1;

            // 使用过滤后的歌词数组
            for (let i = 0; i < filteredLyrics.length; i++) {
                if (currentTime >= filteredLyrics[i].time) {
                    if (i === filteredLyrics.length - 1 ||
                        currentTime < filteredLyrics[i + 1]?.time) {
                        activeLineIndex = i;
                    }
                } else {
                    break;
                }
            }

            // 更新高亮
            lines.forEach((line, index) => {
                line.classList.remove('active');
                if (index === activeLineIndex) {
                    line.classList.add('active');
                }
            });

            // 只有未手动滚动时才自动滚动
            if (!isManualScrolling) {
                const line = lines[activeLineIndex];
                if (line) {
                    const containerHeight = lyricsContainer.clientHeight;
                    const lineHeight = line.clientHeight;
                    const scrollTo = line.offsetTop - (containerHeight / 2) + (lineHeight / 2);
                    lyricsContainer.scrollTo({ top: scrollTo, behavior: 'smooth' });
                }
            }
        }

        // 响应式设置画布大小
        function resizeCanvas() {
            canvas.width = window.innerWidth;
            canvas.height = window.innerHeight;

            // 调整小星星数量基于屏幕大小
            numStars = Math.floor((canvas.width * canvas.height) / 1000);

            // 重置星星数组
            stars.length = 0;
            for (let i = 0; i < numStars; i++) {
                stars.push(createStar());
            }
        }

        let numStars = Math.floor((window.innerWidth * window.innerHeight) / 1000);
        const stars = [];
        const shootingStars = [];
        let score = 0;
        let longPressTimer;
        let isLongPress = false;
        let touchStartTime = 0;

        // 创建静态星星
        function createStar() {
            return {
                x: Math.random() * canvas.width,
                y: Math.random() * canvas.height,
                radius: Math.random() * 1.5,
                opacity: Math.random(),
                blinkSpeed: Math.random() * 0.02 + 0.005,
                blinkDirection: Math.random() > 0.5 ? 1 : -1
            };
        }

        // 初始化星星
        for (let i = 0; i < numStars; i++) {
            stars.push(createStar());
        }

        function drawStars() {
            ctx.clearRect(0, 0, canvas.width, canvas.height);

            // 绘制闪烁的星星
            ctx.fillStyle = 'white';
            for (let star of stars) {
                // 更新星星闪烁效果
                star.opacity += star.blinkSpeed * star.blinkDirection;
                if (star.opacity <= 0.1 || star.opacity >= 1) {
                    star.blinkDirection *= -1;
                }

                ctx.globalAlpha = star.opacity;
                ctx.beginPath();
                ctx.arc(star.x, star.y, star.radius, 0, Math.PI * 2);
                ctx.fill();
            }

            // 绘制流星
            for (let i = shootingStars.length - 1; i >= 0; i--) {
                const star = shootingStars[i];

                // 创建流星尾迹渐变
                const gradient = ctx.createLinearGradient(
                    star.x, star.y,
                    star.x - star.length, star.y + star.length
                );
                gradient.addColorStop(0, `rgba(255, 255, 255, ${star.opacity})`);
                gradient.addColorStop(1, `rgba(255, 255, 255, 0)`);

                ctx.strokeStyle = gradient;
                ctx.lineWidth = star.width;
                ctx.beginPath();
                ctx.moveTo(star.x, star.y);
                ctx.lineTo(star.x - star.length, star.y + star.length);
                ctx.stroke();

                // 添加流星头部光晕
                if (star.opacity > 0.5) {
                    ctx.fillStyle = `rgba(255, 255, 255, ${star.opacity * 0.5})`;
                    ctx.beginPath();
                    ctx.arc(star.x, star.y, star.width * 1.5, 0, Math.PI * 2);
                    ctx.fill();
                }

                // 更新流星位置和透明度
                star.x -= star.speedX;
                star.y += star.speedY;
                star.opacity -= star.fadeSpeed;
                star.width = star.opacity * 2; // 流星随着消失变细

                // 移除超出屏幕或完全消失的流星
                if (star.opacity <= 0 || star.x < 0 || star.y > canvas.height) {
                    shootingStars.splice(i, 1);
                }
            }

            requestAnimationFrame(drawStars);
        }

        // 生成流星
        function generateShootingStar(x, y, isUserGenerated = false) {
            const startX = x || Math.random() * canvas.width;
            const startY = y || Math.random() * canvas.height * 0.2;
            const length = Math.random() * 100 + 50;
            const speed = Math.random() * 5 + 5;
            const colorHue = Math.random() * 60; // 暖色调 (0-60)

            if (isUserGenerated) {
                score++;
                scoreDiv.textContent = `流星: ${score}`;

                // 用户交互时尝试初始化音乐（解决移动端自动播放限制）
                if (!musicInitialized) {
                    initMusic();
                }
            }

            shootingStars.push({
                x: startX,
                y: startY,
                length: length,
                speedX: speed,
                speedY: speed,
                opacity: 1,
                width: 2,
                fadeSpeed: Math.random() * 0.01 + 0.005,
                color: `hsla(${colorHue}, 100%, 80%, 1)`
            });
        }

        // 自动生成流星
        setInterval(() => {
            if (shootingStars.length < 20) { // 限制流星数量
                generateShootingStar();
            }
        }, 500);

        // 音乐控制函数
        function initMusic() {
            if (musicInitialized) return;

            musicInitialized = true;
            loadMusic();

            // 显示音乐信息
            musicInfo.style.display = 'block';
            musicInfo.textContent = `正在播放: ${currentTrack.name}`;

            // 3秒后淡出音乐信息
            setTimeout(() => {
                musicInfo.style.opacity = '0';
                setTimeout(() => {
                    musicInfo.style.display = 'none';
                    musicInfo.style.opacity = '1';
                }, 1000);
            }, 3000);
        }

        function loadMusic() {
            bgMusic.src = currentTrack.url;
            bgMusic.load();
            musicInfo.textContent = `正在播放: ${currentTrack.name}`;

            bgMusic.play().then(() => {
                musicPlaying = true;
                updateMusicIcon();

                // 开始歌词更新循环
                setInterval(() => {
                    if (musicPlaying) {
                        updateLyrics(bgMusic.currentTime);
                    }
                }, 50);
            }).catch(error => {
                console.log("自动播放被阻止:", error);
                musicInfo.textContent = "点击页面以播放音乐";
            });
        }

        function toggleMusic() {
            if (!musicInitialized) {
                initMusic();
                return;
            }

            if (musicPlaying) {
                bgMusic.pause();
            } else {
                bgMusic.play().catch(error => {
                    console.log("播放失败:", error);
                    musicInfo.style.display = 'block';
                    musicInfo.textContent = "需要用户交互后才能播放音乐";
                    setTimeout(() => {
                        musicInfo.style.opacity = '0';
                        setTimeout(() => {
                            musicInfo.style.display = 'none';
                            musicInfo.style.opacity = '1';
                        }, 1000);
                    }, 2000);
                });
            }
            musicPlaying = !musicPlaying;
            updateMusicIcon();
        }

        function updateMusicIcon() {
            const icon = musicControl.querySelector('i');
            if (musicPlaying) {
                icon.classList.remove('fa-music');
                icon.classList.add('fa-pause');
            } else {
                icon.classList.remove('fa-pause');
                icon.classList.add('fa-music');
            }
        }

        // 点击/触摸事件处理
        function handleInteraction(x, y, isLongPress = false) {
            const count = isLongPress ? 10 : 1;
            for (let i = 0; i < count; i++) {
                // 添加一些随机偏移，使长按时效果更丰富
                const offsetX = isLongPress ? (Math.random() - 0.5) * 100 : 0;
                const offsetY = isLongPress ? (Math.random() - 0.5) * 50 : 0;
                generateShootingStar(x + offsetX, y + offsetY, true);
            }

            // 点击反馈效果 - 创建圆形波纹
            if (!isLongPress) {
                const ripple = {
                    x: x,
                    y: y,
                    radius: 5,
                    opacity: 0.8,
                    color: 'white'
                };

                const rippleInterval = setInterval(() => {
                    ripple.radius += 5;
                    ripple.opacity -= 0.05;

                    if (ripple.opacity <= 0) {
                        clearInterval(rippleInterval);
                    }
                }, 30);

                // 临时绘制一次波纹
                ctx.beginPath();
                ctx.arc(ripple.x, ripple.y, ripple.radius, 0, Math.PI * 2);
                ctx.strokeStyle = `rgba(255, 255, 255, ${ripple.opacity})`;
                ctx.lineWidth = 2;
                ctx.stroke();
            }
        }

        // 鼠标/触摸事件监听
        canvas.addEventListener('click', (e) => {
            handleInteraction(e.clientX, e.clientY);
        });

        canvas.addEventListener('touchstart', (e) => {
            e.preventDefault();
            touchStartTime = Date.now();
            const touch = e.touches[0];
            longPressTimer = setTimeout(() => {
                isLongPress = true;
                handleInteraction(touch.clientX, touch.clientY, true);
            }, 500);
        });

        canvas.addEventListener('touchend', (e) => {
            e.preventDefault();
            clearTimeout(longPressTimer);
            if (!isLongPress && e.changedTouches[0]) {
                const touch = e.changedTouches[0];
                handleInteraction(touch.clientX, touch.clientY);
            }
            isLongPress = false;
        });

        canvas.addEventListener('touchmove', (e) => {
            e.preventDefault();
            if (isLongPress && e.touches[0]) {
                const touch = e.touches[0];
                handleInteraction(touch.clientX, touch.clientY, true);
            }
        });

        // 鼠标移动时在指针周围生成小星星
        canvas.addEventListener('mousemove', (e) => {
            if (Math.random() > 0.7) { // 70%的几率不生成，避免太多
                generateShootingStar(
                    e.clientX + (Math.random() - 0.5) * 50,
                    e.y + (Math.random() - 0.5) * 50,
                    true
                );
            }
        });

        // 音乐控制按钮事件
        musicControl.addEventListener('click', (e) => {
            e.stopPropagation();
            toggleMusic();
        });

        // 窗口大小调整
        window.addEventListener('resize', resizeCanvas);

        // 音频事件监听
        bgMusic.addEventListener('error', () => {
            lyricsContainer.scrollTop = 0; // 重置滚动位置
            musicInfo.style.display = 'block';
            musicInfo.textContent = "音乐加载失败，请检查网络连接";
            setTimeout(() => {
                musicInfo.style.opacity = '0';
                setTimeout(() => {
                    musicInfo.style.display = 'none';
                    musicInfo.style.opacity = '1';
                }, 1000);
            }, 2000);
        });

        // 初始化
        resizeCanvas();
        drawStars();
        initLyrics(); // 初始化歌词显示

        // 5秒后淡出提示信息
        setTimeout(() => {
            let opacity = 1;
            const fadeInterval = setInterval(() => {
                opacity -= 0.02;
                infoDiv.style.opacity = opacity;
                if (opacity <= 0) {
                    clearInterval(fadeInterval);
                    infoDiv.style.display = 'none';
                }
            }, 50);
        }, 5000);

        let isDragging = false;
        let startY = 0;
        let currentScrollTop = 0;
        // 新增手动滚动标志
        let isManualScrolling = false;


        // 触摸事件
        lyricsContainer.addEventListener('touchstart', (e) => {
            isManualScrolling = true;
            startY = e.touches[0].clientY;
            currentScrollTop = lyricsContainer.scrollTop;
            isDragging = true;
        });

        lyricsContainer.addEventListener('touchmove', (e) => {
            if (!isDragging) return;
            const deltaY = e.touches[0].clientY - startY;
            lyricsContainer.scrollTop = currentScrollTop - deltaY;
            e.preventDefault();
        });

        lyricsContainer.addEventListener('touchend', () => {
            isManualScrolling = false;
            isDragging = false;
        });

        // 鼠标事件
        lyricsContainer.addEventListener('mousedown', (e) => {
            isManualScrolling = true;
            startY = e.clientY;
            currentScrollTop = lyricsContainer.scrollTop;
            isDragging = true;
        });

        document.addEventListener('mousemove', (e) => {
            if (!isDragging) return;
            const deltaY = e.clientY - startY;
            lyricsContainer.scrollTop = currentScrollTop - deltaY;
            e.preventDefault();
        });

        document.addEventListener('mouseup', () => {
            isManualScrolling = false;
            isDragging = false;
        });
    </script>
</body>

</html>
